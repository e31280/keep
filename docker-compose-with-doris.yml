# Docker Compose for Keep with Apache Doris
#
# Apache Doris is used as the main database via MySQL protocol.
# Connection: mysql+pymysql://root:@keep-doris-fe:9030/keep
#
# Usage:
#   docker compose -f docker-compose-with-doris.yml up -d
#
# Doris FE (Frontend) serves the MySQL protocol on port 9030.
# Doris BE (Backend) handles data storage and computation.

services:
  keep-doris-fe:
    image: apache/doris:doris-all-in-one-2.1
    ports:
      - "8030:8030"   # FE HTTP port
      - "9030:9030"   # FE MySQL protocol port
    environment:
      - FE_SERVERS=fe1:127.0.0.1:9010
      - FE_ID=1
    volumes:
      - doris-fe-data:/opt/apache-doris/fe/doris-meta
      - doris-be-data:/opt/apache-doris/be/storage
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-P", "9030", "-u", "root"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

  keep-frontend:
    extends:
      file: docker-compose.common.yml
      service: keep-frontend-common
    image: us-central1-docker.pkg.dev/keephq/keep/keep-ui
    environment:
      - AUTH_TYPE=NO_AUTH
      - API_URL=http://keep-backend:8080
    depends_on:
      - keep-backend

  keep-backend:
    extends:
      file: docker-compose.common.yml
      service: keep-backend-common
    image: us-central1-docker.pkg.dev/keephq/keep/keep-api
    environment:
      - AUTH_TYPE=NO_AUTH
      - DATABASE_CONNECTION_STRING=mysql+pymysql://root:@keep-doris-fe:9030/keep
      - KEEP_DATABASE_TYPE=doris
      # Doris does not support Alembic migrations; create the schema manually.
      # See docs/deployment/database-migration-doris-clickhouse.md for details.
      - SKIP_DB_CREATION=true
    volumes:
      - ./state:/state
    depends_on:
      keep-doris-fe:
        condition: service_healthy

  keep-websocket-server:
    extends:
      file: docker-compose.common.yml
      service: keep-websocket-server-common

volumes:
  doris-fe-data:
  doris-be-data:
